name: Fastlane CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # test:
  #   runs-on: macos-latest
    
  #   steps:
  #   - uses: actions/checkout@v3
    
  #   - name: Set up Ruby
  #     uses: ruby/setup-ruby@v1
  #     with:
  #       ruby-version: '3.1.5'
  #       bundler-cache: true
  #       working-directory: ./fastlane
    
  #   - name: Set up Flutter
  #     uses: subosito/flutter-action@v2
  #     with:
  #       flutter-version: '3.38.3'
    
  #   - name: Get Flutter dependencies
  #     run: flutter pub get
    
  #   - name: Run Flutter tests
  #     working-directory: ./fastlane
  #     run: bundle exec fastlane flutter_test

  build-android:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1.5'
        bundler-cache: true
        working-directory: ./fastlane
    
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.3'
    
    - name: Get Flutter dependencies
      run: flutter pub get
    
    - name: Create Android signing files
      run: |
        # Create key.properties file from GitHub Secrets
        echo "Creating key.properties file..."
        mkdir -p android
        
        # Write key.properties content
        echo "storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}" > android/key.properties
        echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
        echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
        echo "storeFile=app/release.keystore" >> android/key.properties
        
        # Create release keystore file from GitHub Secrets
        echo "Creating release.keystore file..."
        mkdir -p android/app
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.keystore
        
        # Verify files were created successfully
        echo "=== Signing files verification ==="
        ls -la android/key.properties
        ls -la android/app/release.keystore
        echo "Key properties content:"
        cat android/key.properties
        echo "Key store file size: $(ls -lh android/app/release.keystore | awk '{print $5}')"
    
    - name: Build Android APK
      working-directory: ./fastlane
      run: bundle exec fastlane android build
    
    - name: Check Generated APK File
      run: |
        echo "=== Looking for generated APK files ==="
        find . -name "*.apk" -type f | grep -v "build-cache" | sort
        
        echo "\n=== Checking build/app/outputs/flutter-apk directory ==="
        ls -la build/app/outputs/flutter-apk
        
        echo "=== Verifying APK file exists ==="
        if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
          echo "APK file found at: build/app/outputs/flutter-apk/app-release.apk"
          echo "APK file size: $(ls -lh build/app/outputs/flutter-apk/app-release.apk | awk '{print $5}')"
          # Copy APK to root directory for simpler upload
          cp build/app/outputs/flutter-apk/app-release.apk ./app-release.apk
          echo "APK file copied to root directory: $(ls -lh app-release.apk)"
        else
          echo "ERROR: APK file not found!"
          exit 1
        fi

    - name: Create Download HTML
      run: |
        echo "<html>" > download.html
        echo "<body>" >> download.html
        echo "<h1>App Downloads</h1>" >> download.html
        echo "<p>Click below to download the latest versions:</p>" >> download.html
        echo "<h2>Android</h2>" >> download.html
        echo "<a href='app-release.apk' download>Download APK</a>" >> download.html
        echo "<h2>iOS</h2>" >> download.html
        echo "<a href='Runner.app' download>Download iOS App</a>" >> download.html
        echo "</body>" >> download.html
        echo "</html>" >> download.html

    - name: Install SSH client and sshpass
      run: |
        brew install openssh
        brew install hudochenkov/sshpass/sshpass

    - name: Debug and check GitHub Secrets
      run: |
        echo "Debug: Checking GitHub Secrets..."
        echo "SERVER_HOST exists: ${{ secrets.SERVER_HOST != '' }}"
        echo "SERVER_USERNAME exists: ${{ secrets.SERVER_USERNAME != '' }}"
        echo "SERVER_PASSWORD exists: ${{ secrets.SERVER_PASSWORD != '' }}"
        
        # Check if all required secrets are set
        if [ -z "${{ secrets.SERVER_HOST }}" ] || [ -z "${{ secrets.SERVER_USERNAME }}" ] || [ -z "${{ secrets.SERVER_PASSWORD }}" ]; then
          echo "ERROR: Missing required GitHub Secrets!"
          echo "Please check that SERVER_HOST, SERVER_USERNAME, and SERVER_PASSWORD are set in repository Secrets."
          exit 1
        fi

    - name: Add server to known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        chmod 600 ~/.ssh/known_hosts

    - name: Create SSH config
      run: |
        echo "Host upload-server"
        echo "  HostName ${{ secrets.SERVER_HOST }}"
        echo "  User ${{ secrets.SERVER_USERNAME }}"
        echo "  PasswordAuthentication yes"
        echo "  StrictHostKeyChecking no"
        echo "  UserKnownHostsFile ~/.ssh/known_hosts" > ~/.ssh/config
        chmod 600 ~/.ssh/config

    - name: Upload APK and HTML to Server (Optimized)
      run: |
        # Optimize SCP with faster encryption, compression, and single connection
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' scp -P 22 -c aes128-gcm@openssh.com -C app-release.apk download.html ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }}:/var/www/html/

    - name: Verify Files on Server (Direct SSH)
      run: |
        # Use sshpass and ssh directly to run commands on server
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' ssh -p 22 ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} << 'EOF'
        echo "=== Checking /var/www/html directory contents ==="
        ls -la /var/www/html
        
        echo "\n=== Fixing APK file location if needed ==="
        if [ -f /var/www/html/app-release.apk ]; then
          echo "APK file is already in correct location: /var/www/html/app-release.apk"
        else
          echo "ERROR: APK file not found!"
        fi
        
        echo "\n=== Checking file permissions ==="
        ls -lh /var/www/html/*.apk 2>/dev/null || echo "No APK files found"
        ls -lh /var/www/html/download.html 2>/dev/null || echo "No HTML file found"
        
        echo "\n=== Setting proper permissions ==="
        chmod 644 /var/www/html/app-release.apk 2>/dev/null
        chmod 644 /var/www/html/download.html 2>/dev/null
        
        echo "\n=== Final directory contents ==="
        ls -la /var/www/html
        EOF

  build-ios:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1.5'
        bundler-cache: true
        working-directory: ./fastlane
    
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.3'
    
    - name: Get Flutter dependencies
      run: flutter pub get
    
    - name: Build iOS app
      working-directory: ./fastlane
      run: bundle exec fastlane ios build
    
    - name: Check Generated iOS App
      run: |
        echo "=== Looking for generated iOS app files ==="
        find . -name "Runner.app" -type d | sort
        
        echo "\n=== Checking build/ios/iphoneos directory ==="
        ls -la build/ios/iphoneos
        
        echo "=== Verifying iOS app exists ==="
        if [ -d "build/ios/iphoneos/Runner.app" ]; then
          echo "iOS app found at: build/ios/iphoneos/Runner.app"
          echo "iOS app size: $(du -sh build/ios/iphoneos/Runner.app | awk '{print $1}')"
          # Copy iOS app to root directory for simpler upload
          cp -r build/ios/iphoneos/Runner.app ./Runner.app
          echo "iOS app copied to root directory: $(du -sh Runner.app | awk '{print $1}')"
        else
          echo "ERROR: iOS app not found!"
          exit 1
        fi

    - name: Install SSH client and sshpass
      run: |
        brew install openssh
        brew install hudochenkov/sshpass/sshpass

    - name: Debug and check GitHub Secrets
      run: |
        echo "Debug: Checking GitHub Secrets..."
        echo "SERVER_HOST exists: ${{ secrets.SERVER_HOST != '' }}"
        echo "SERVER_USERNAME exists: ${{ secrets.SERVER_USERNAME != '' }}"
        echo "SERVER_PASSWORD exists: ${{ secrets.SERVER_PASSWORD != '' }}"
        
        # Check if all required secrets are set
        if [ -z "${{ secrets.SERVER_HOST }}" ] || [ -z "${{ secrets.SERVER_USERNAME }}" ] || [ -z "${{ secrets.SERVER_PASSWORD }}" ]; then
          echo "ERROR: Missing required GitHub Secrets!"
          echo "Please check that SERVER_HOST, SERVER_USERNAME, and SERVER_PASSWORD are set in repository Secrets."
          exit 1
        fi

    - name: Add server to known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        chmod 600 ~/.ssh/known_hosts

    - name: Create SSH config
      run: |
        echo "Host upload-server"
        echo "  HostName ${{ secrets.SERVER_HOST }}"
        echo "  User ${{ secrets.SERVER_USERNAME }}"
        echo "  PasswordAuthentication yes"
        echo "  StrictHostKeyChecking no"
        echo "  UserKnownHostsFile ~/.ssh/known_hosts" > ~/.ssh/config
        chmod 600 ~/.ssh/config

    - name: Upload iOS App to Server (Optimized)
      run: |
        # Optimize SCP with faster encryption, compression for iOS app
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' scp -P 22 -c aes128-gcm@openssh.com -C -r Runner.app ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }}:/var/www/html/

    - name: Verify iOS Files on Server (Direct SSH)
      run: |
        # Use sshpass and ssh directly to run commands on server
        sshpass -p '${{ secrets.SERVER_PASSWORD }}' ssh -p 22 ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} << 'EOF'
        echo "=== Checking iOS app on server ==="
        if [ -d /var/www/html/Runner.app ]; then
          echo "iOS app is in correct location: /var/www/html/Runner.app"
          echo "iOS app size: $(du -sh /var/www/html/Runner.app | awk '{print $1}')"
        else
          echo "ERROR: iOS app not found!"
        fi
        
        echo "\n=== Setting proper permissions for iOS app ==="
        chmod -R 755 /var/www/html/Runner.app 2>/dev/null
        
        echo "\n=== Final directory contents ==="
        ls -la /var/www/html
        EOF